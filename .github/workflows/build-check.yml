name: Build Check

on:
  pull_request:
    branches: [ "development","main" ]

jobs:
  tests:
    name: Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Start Mock Server
        shell: pwsh
        run: |
          # Start mock server in background
          Start-Process pwsh -ArgumentList "-File", "${{ github.workspace }}/tests/Start-MockServer.ps1" -NoNewWindow
          
          # Wait for server to be ready
          $maxAttempts = 10
          $attempt = 0
          $serverReady = $false
          
          while ($attempt -lt $maxAttempts -and -not $serverReady) {
            $attempt++
            Start-Sleep -Seconds 2
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:3000/HealthCheck" -TimeoutSec 2 -ErrorAction SilentlyContinue
              if ($response.StatusCode -eq 200) {
                Write-Host "Mock server started successfully"
                $serverReady = $true
              }
            } catch {
              Write-Host "Waiting for mock server (attempt $attempt/$maxAttempts)"
            }
          }
          
          if (-not $serverReady) {
            Write-Host "ERROR: Mock server failed to start"
            exit 1
          }
        env:
          MOCK_API: http://127.0.0.1:3000      
      
      - name: Run Pester Unit Tests
        shell: pwsh
        run: |
          Invoke-Pester -Path ./tests/action.Tests.ps1

      - name: Run Integration Tests
        id: integration-tests
        uses: ./
        with:
          user: 'test-user'
          team-slug: 'test-team'
          token: 'fake-token'
          owner: 'test-owner'
        env:
          MOCK_API: http://127.0.0.1:3000

      - name: Check Integration Test Result
        shell: pwsh
        run: |
          if ("${{ steps.integration-tests.outputs.result }}" -eq "success"  && "${{ steps.integration-tests.outputs.is-member }}" -eq "true") {
            Write-Host "Test passed: Integration test simulated successfully."
          } else {
            Write-Host "Test failed: ${{ steps.integration-tests.outputs.error-message }}"
            exit 1
          }